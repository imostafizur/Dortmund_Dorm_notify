{
  "name": "STWDO Dorm Alert â†’ Telegram (with Test Mode)",
  "nodes": [
    {
      "parameters": {},
      "id": "f1b9fdb0-9a6c-4f9b-91f9-4302b5ed9b40",
      "name": "Manual Trigger (test now)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 140]
    },
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 5,
              "unit": "minutes"
            }
          ]
        }
      },
      "id": "0c4b3f2f-10d2-4d22-bc7e-0b45584e6a78",
      "name": "Cron (every 5 min)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition"
      },
      "id": "5b1f0a5a-79c1-4aa5-8cf4-761a7d86c3c5",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [440, 220]
    },
    {
      "parameters": {
        "values": {
          "boolean": [
            {
              "name": "testMode",
              "value": true
            }
          ]
        },
        "options": {}
      },
      "id": "89c3a6ef-50e5-46d2-9b8e-d8c6a7b8b2b2",
      "name": "Set testMode (true/false)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [640, 220]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.testMode}}",
              "operation": "isTrue"
            }
          ]
        }
      },
      "id": "1a10b1aa-0e2d-4c0e-b8dc-3b91824f4b67",
      "name": "IF testMode?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [860, 220]
    },
    {
      "parameters": {
        "values": {
          "number": [
            {
              "name": "count",
              "value": 1
            }
          ],
          "boolean": [
            {
              "name": "noOffers",
              "value": false
            }
          ],
          "string": [
            {
              "name": "source",
              "value": "TEST"
            }
          ],
          "json": [
            {
              "name": "offers",
              "value": "={{[{\"title\":\"TEST OFFER (Fake)\",\"url\":\"https://www.stwdo.de/wohnen/aktuelle-wohnangebote/test\"}]}}"
            }
          ]
        },
        "options": {}
      },
      "id": "c7a1c3c9-10ce-4b3d-9f45-5f6cbb8eb5c2",
      "name": "Create Fake Offer",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1080, 120]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://www.stwdo.de/wohnen/aktuelle-wohnangebote",
        "responseFormat": "string",
        "options": {
          "timeout": 30000,
          "followRedirect": true
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (n8n; STWDO dorm checker)"
            },
            {
              "name": "Accept-Language",
              "value": "de-DE,de;q=0.9,en;q=0.8"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml"
            }
          ]
        }
      },
      "id": "b0e5a0b8-941a-4ad0-9a15-4a3521f7ac97",
      "name": "Fetch STWDO page",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1080, 320]
    },
    {
      "parameters": {
        "jsCode": "const html = $json.body || '';\n\nconst noOffers = /Keine\\s+Angebote/i.test(html);\nconst base = 'https://www.stwdo.de';\n\n// Extract offer links like /wohnen/aktuelle-wohnangebote/<something>\nconst linkRegex = /href\\s*=\\s*\"(\\/wohnen\\/aktuelle-wohnangebote\\/[^\"]+)\"/gi;\nconst links = new Set();\nlet m;\nwhile ((m = linkRegex.exec(html)) !== null) {\n  const path = m[1];\n  if (path === '/wohnen/aktuelle-wohnangebote') continue;\n  links.add(base + path);\n}\n\n// Best-effort titles from anchor text\nconst offers = [];\nfor (const url of links) {\n  const path = url.replace(base, '');\n  const escapedPath = path.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n  const aTag = new RegExp(`<a[^>]*href=\\\\\"${escapedPath}\\\\\"[^>]*>([\\\\s\\\\S]*?)<\\\\/a>`, 'i');\n  const aMatch = html.match(aTag);\n  let title = '';\n  if (aMatch && aMatch[1]) {\n    title = aMatch[1].replace(/<[^>]+>/g, ' ').replace(/\\s+/g, ' ').trim();\n  }\n  offers.push({ url, title: title || 'STWDO Wohnangebot' });\n}\n\nreturn [\n  {\n    json: {\n      source: 'LIVE',\n      noOffers,\n      count: offers.length,\n      offers\n    }\n  }\n];"
      },
      "id": "61a6bc10-12f3-46b4-9b25-164ed5d45f86",
      "name": "Parse offers",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1290, 320]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition"
      },
      "id": "5d7b67f8-2c35-4c30-987c-2b1c0ddf5f0c",
      "name": "Merge Offers (TEST/LIVE)",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [1500, 220]
    },
    {
      "parameters": {
        "jsCode": "const data = getWorkflowStaticData('global');\nif (!data.seenUrls) data.seenUrls = {};\n\nconst offers = $json.offers || [];\nconst newOnes = [];\n\nfor (const o of offers) {\n  if (!o || !o.url) continue;\n  if (!data.seenUrls[o.url]) {\n    newOnes.push(o);\n    data.seenUrls[o.url] = new Date().toISOString();\n  }\n}\n\n// Keep last ~500\nconst keys = Object.keys(data.seenUrls);\nif (keys.length > 500) {\n  const sorted = keys\n    .map(k => ({ k, t: data.seenUrls[k] }))\n    .sort((a, b) => (a.t < b.t ? -1 : 1));\n  for (const item of sorted.slice(0, keys.length - 500)) delete data.seenUrls[item.k];\n}\n\nreturn [\n  {\n    json: {\n      source: $json.source || 'UNKNOWN',\n      newCount: newOnes.length,\n      newOffers: newOnes\n    }\n  }\n];"
      },
      "id": "f5df9a2c-6c31-4f2c-b8a6-6f392b2a9d86",
      "name": "Filter only NEW offers",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1710, 220]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.newCount}}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "f2b4f68d-22d1-4b0d-a6b4-20a1bb0e0f46",
      "name": "Any NEW offers?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1920, 220]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "PUT_CHAT_ID_HERE",
        "text": "={{'ðŸ  ' + ($json.source === 'TEST' ? 'TEST MODE' : 'NEW') + ' STWDO offer(s): ' + $json.newCount + \"\\n\\n\" + ($json.newOffers || []).map((o, i) => `${i+1}) ${o.title}\\n${o.url}`).join(\"\\n\\n\") + \"\\n\\nListing: https://www.stwdo.de/wohnen/aktuelle-wohnangebote\"}}",
        "additionalFields": {
          "disableNotification": false
        }
      },
      "id": "6a84d2ad-2d39-4850-9f5b-2f9c8bd3e3e9",
      "name": "Telegram 1 - Notify",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [2150, 140]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "PUT_CHAT_ID_HERE",
        "text": "={{'ðŸ  ' + ($json.source === 'TEST' ? 'TEST MODE' : 'NEW') + ' STWDO offer(s): ' + $json.newCount + \"\\n\\n\" + ($json.newOffers || []).map((o, i) => `${i+1}) ${o.title}\\n${o.url}`).join(\"\\n\\n\") + \"\\n\\nListing: https://www.stwdo.de/wohnen/aktuelle-wohnangebote\"}}",
        "additionalFields": {
          "disableNotification": false
        }
      },
      "id": "1a6803d9-6b43-4a8b-8840-85c0ef3c17c5",
      "name": "Telegram 2 - Notify",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [2150, 300]
    }
  ],
  "connections": {
    "Manual Trigger (test now)": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cron (every 5 min)": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Set testMode (true/false)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set testMode (true/false)": {
      "main": [
        [
          {
            "node": "IF testMode?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF testMode?": {
      "main": [
        [
          {
            "node": "Create Fake Offer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch STWDO page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Fake Offer": {
      "main": [
        [
          {
            "node": "Merge Offers (TEST/LIVE)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch STWDO page": {
      "main": [
        [
          {
            "node": "Parse offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse offers": {
      "main": [
        [
          {
            "node": "Merge Offers (TEST/LIVE)",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Offers (TEST/LIVE)": {
      "main": [
        [
          {
            "node": "Filter only NEW offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter only NEW offers": {
      "main": [
        [
          {
            "node": "Any NEW offers?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any NEW offers?": {
      "main": [
        [
          {
            "node": "Telegram 1 - Notify",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram 2 - Notify",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionTimeout": 120,
    "saveExecutionProgress": true,
    "saveManualExecutions": true
  },
  "versionId": "1"
}
