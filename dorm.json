{
  "name": "STWDO Dorm Alert â†’ Telegram (Import-Safe + Test Mode)",
  "nodes": [
    {
      "parameters": {},
      "id": "manualTrigger",
      "name": "Manual Trigger (TEST NOW)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [220, 160]
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { mode: 'TEST' } }];"
      },
      "id": "setTestMode",
      "name": "Set Mode = TEST",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 160]
    },
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 5,
              "unit": "minutes"
            }
          ]
        }
      },
      "id": "cron",
      "name": "Cron (every 5 min)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [220, 360]
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { mode: 'LIVE' } }];"
      },
      "id": "setLiveMode",
      "name": "Set Mode = LIVE",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 360]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.mode}}",
              "operation": "equal",
              "value2": "TEST"
            }
          ]
        }
      },
      "id": "ifTest",
      "name": "IF Mode is TEST?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [660, 260]
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      source: 'TEST',\n      offers: [\n        {\n          title: 'TEST OFFER (Fake) - import check',\n          url: 'https://www.stwdo.de/wohnen/aktuelle-wohnangebote/test'\n        }\n      ]\n    }\n  }\n];"
      },
      "id": "fakeOffer",
      "name": "Create Fake Offer (TEST)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 140]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://www.stwdo.de/wohnen/aktuelle-wohnangebote",
        "responseFormat": "string",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (n8n; STWDO dorm checker)"
            },
            {
              "name": "Accept-Language",
              "value": "de-DE,de;q=0.9,en;q=0.8"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml"
            }
          ]
        }
      },
      "id": "fetchPage",
      "name": "Fetch STWDO page (LIVE)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [900, 420]
    },
    {
      "parameters": {
        "jsCode": "const html = $json.body || '';\nconst base = 'https://www.stwdo.de';\n\n// Extract offer links like /wohnen/aktuelle-wohnangebote/<something>\nconst linkRegex = /href\\s*=\\s*\"(\\/wohnen\\/aktuelle-wohnangebote\\/[^\"]+)\"/gi;\nconst links = new Set();\nlet m;\nwhile ((m = linkRegex.exec(html)) !== null) {\n  const path = m[1];\n  if (path === '/wohnen/aktuelle-wohnangebote') continue;\n  links.add(base + path);\n}\n\nconst offers = Array.from(links).map((url) => ({\n  title: 'STWDO Wohnangebot',\n  url\n}));\n\nreturn [{ json: { source: 'LIVE', offers } }];"
      },
      "id": "parseOffers",
      "name": "Parse offers (LIVE)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 420]
    },
    {
      "parameters": {
        "jsCode": "const data = getWorkflowStaticData('global');\nif (!data.seenUrls) data.seenUrls = {};\n\nconst offers = $json.offers || [];\nconst newOnes = [];\n\nfor (const o of offers) {\n  if (!o || !o.url) continue;\n  if (!data.seenUrls[o.url]) {\n    newOnes.push(o);\n    data.seenUrls[o.url] = new Date().toISOString();\n  }\n}\n\nreturn [{ json: { source: $json.source, newCount: newOnes.length, newOffers: newOnes } }];"
      },
      "id": "filterNew",
      "name": "Filter only NEW offers",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 260]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.newCount}}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "ifAnyNew",
      "name": "Any NEW offers?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1560, 260]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "PUT_CHAT_ID_FOR_BOT_1",
        "text": "={{'ðŸ  ' + ($json.source === 'TEST' ? 'TEST MODE' : 'NEW') + ' STWDO offer(s): ' + $json.newCount + \"\\n\\n\" + ($json.newOffers || []).map((o, i) => `${i+1}) ${o.title}\\n${o.url}`).join(\"\\n\\n\") + \"\\n\\nListing: https://www.stwdo.de/wohnen/aktuelle-wohnangebote\"}}"
      },
      "id": "tg1",
      "name": "Telegram 1 - Notify",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1780, 180]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "PUT_CHAT_ID_FOR_BOT_2",
        "text": "={{'ðŸ  ' + ($json.source === 'TEST' ? 'TEST MODE' : 'NEW') + ' STWDO offer(s): ' + $json.newCount + \"\\n\\n\" + ($json.newOffers || []).map((o, i) => `${i+1}) ${o.title}\\n${o.url}`).join(\"\\n\\n\") + \"\\n\\nListing: https://www.stwdo.de/wohnen/aktuelle-wohnangebote\"}}"
      },
      "id": "tg2",
      "name": "Telegram 2 - Notify",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1780, 340]
    }
  ],
  "connections": {
    "Manual Trigger (TEST NOW)": {
      "main": [
        [
          {
            "node": "Set Mode = TEST",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Mode = TEST": {
      "main": [
        [
          {
            "node": "IF Mode is TEST?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cron (every 5 min)": {
      "main": [
        [
          {
            "node": "Set Mode = LIVE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Mode = LIVE": {
      "main": [
        [
          {
            "node": "IF Mode is TEST?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Mode is TEST?": {
      "main": [
        [
          {
            "node": "Create Fake Offer (TEST)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch STWDO page (LIVE)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Fake Offer (TEST)": {
      "main": [
        [
          {
            "node": "Filter only NEW offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch STWDO page (LIVE)": {
      "main": [
        [
          {
            "node": "Parse offers (LIVE)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse offers (LIVE)": {
      "main": [
        [
          {
            "node": "Filter only NEW offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter only NEW offers": {
      "main": [
        [
          {
            "node": "Any NEW offers?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any NEW offers?": {
      "main": [
        [
          {
            "node": "Telegram 1 - Notify",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram 2 - Notify",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionTimeout": 120,
    "saveExecutionProgress": true,
    "saveManualExecutions": true
  }
}
