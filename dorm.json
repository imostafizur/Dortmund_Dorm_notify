{
  "name": "STWDO Dorm Alert (Stable Version)",
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 5,
              "unit": "minutes"
            }
          ]
        }
      },
      "id": "cron1",
      "name": "Cron (every 5 min)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://www.stwdo.de/wohnen/aktuelle-wohnangebote",
        "responseFormat": "string",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0"
            }
          ]
        }
      },
      "id": "http1",
      "name": "Fetch STWDO",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [420, 300]
    },
    {
      "parameters": {
        "jsCode": "const html = ($json.body || '').slice(0, 50000);\n\nconst base = 'https://www.stwdo.de';\nconst regex = /href\\s*=\\s*\"(\\/wohnen\\/aktuelle-wohnangebote\\/[^\"]+)\"/gi;\n\nconst found = new Set();\nlet match;\n\nwhile ((match = regex.exec(html)) !== null) {\n  const path = match[1];\n  if (path !== '/wohnen/aktuelle-wohnangebote') {\n    found.add(base + path);\n  }\n}\n\nconst data = getWorkflowStaticData('global');\nif (!data.seen) data.seen = {};\n\nconst newOffers = [];\n\nfor (const url of found) {\n  if (!data.seen[url]) {\n    data.seen[url] = true;\n    newOffers.push({ url });\n  }\n}\n\nreturn [{ json: { count: newOffers.length, offers: newOffers } }];"
      },
      "id": "code1",
      "name": "Parse + Filter New",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.count}}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "if1",
      "name": "If New Offers?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [880, 300]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "PUT_CHAT_ID_BOT_1",
        "text": "={{'ðŸ  NEW STWDO DORM AVAILABLE!\\n\\n' + ($json.offers || []).map(o => o.url).join('\\n')}}"
      },
      "id": "tg1",
      "name": "Telegram 1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1100, 220]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "PUT_CHAT_ID_BOT_2",
        "text": "={{'ðŸ  NEW STWDO DORM AVAILABLE!\\n\\n' + ($json.offers || []).map(o => o.url).join('\\n')}}"
      },
      "id": "tg2",
      "name": "Telegram 2",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1100, 380]
    }
  ],
  "connections": {
    "Cron (every 5 min)": {
      "main": [
        [
          {
            "node": "Fetch STWDO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch STWDO": {
      "main": [
        [
          {
            "node": "Parse + Filter New",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse + Filter New": {
      "main": [
        [
          {
            "node": "If New Offers?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If New Offers?": {
      "main": [
        [
          {
            "node": "Telegram 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram 2",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "active": false
}
